# OpenCode Plugin for Obsidian

Embed the [OpenCode](https://opencode.ai) AI assistant directly in Obsidian with deep vault integration.

<img src="./assets/opencode_in_obsidian.png" alt="OpenCode embedded in Obsidian" />

## Features

- **Vault Context**: Automatically injects active file, selection, and open tabs into AI context
- **Personalities**: Switch between professional, efficient, fact-based, or exploratory modes
- **Canvas Workflows**: Compile `.canvas` files into executable AI workflows
- **Secure**: All communication via localhost; no data leaves your machine except to your configured AI provider

## Requirements

- **Desktop only** (uses Node.js child processes)
- [OpenCode CLI](https://opencode.ai) installed and in PATH
- [Bun](https://bun.sh) for building

## Installation

### From Source

```bash
cd your-vault/.obsidian/plugins
git clone https://github.com/mtymek/opencode-obsidian.git
cd opencode-obsidian
git submodule update --init --recursive
bun install
bun run build:all
```

Enable in **Obsidian Settings > Community Plugins**.

## Usage

1. Click the OpenCode icon in the ribbon, or use `Cmd/Ctrl+Shift+O`
2. Server starts automatically when the panel opens
3. Select or create a session in the UI
4. Start chatting with full vault context

### Commands

| Command | Description |
|---------|-------------|
| Toggle OpenCode panel | Show/hide the sidebar panel |
| Start OpenCode server | Manually start the server |
| Stop OpenCode server | Manually stop the server |

### Context Injection

The plugin automatically tracks:
- **Active file**: Currently focused markdown file
- **Selection**: Selected text in the editor
- **Open tabs**: All open markdown files
- **Cursor position**: Line and column

Context is injected via `noReply` (no extra assistant responses).

### Personalities

Built-in presets:
- **Professional**: Clear, concise, business-appropriate
- **Efficient**: Minimal responses, maximum utility
- **Fact-Based**: Evidence-focused, cites sources
- **Exploratory**: Thorough analysis, multiple perspectives

### Canvas Workflows

Create visual AI workflows using Obsidian Canvas:
1. Create a `.canvas` file with text nodes (prompts) and edges (dependencies)
2. Use `ui/canvas/compileWorkflow` to compile to executable format
3. Workflow runs nodes in topological order

## Development

### Setup

```bash
git clone https://github.com/mtymek/opencode-obsidian.git
cd opencode-obsidian
git submodule update --init --recursive
bun install
```

### Build

```bash
bun run build          # Plugin only
bun run build:all      # Plugin + vendored UI
bun run dev            # Watch mode
```

### Test

```bash
bun test tests/        # Unit tests
```

### Project Structure

```
src/
├── main.ts              # Plugin entry
├── types.ts             # Settings and constants
├── view/                # OpenWorkView (iframe host)
├── opencode/            # ServerManager, OpenCodeClient
├── bridge/              # BridgeHost, message types, Zod schemas
├── context/             # ContextTracker, ContextInjector, Personalities
├── workflow/            # CanvasCompiler, WorkflowRunner
└── util/                # Helpers (debounce, hash, path)

vendor/opencode/         # Vendored OpenCode UI (git submodule)
assets/openwork/         # Built UI (generated by build:all)
```

## Security

- Server binds to `127.0.0.1` only
- CORS restricted to `app://obsidian.md`
- Bridge validates origin, protocol, version, channelId, and payload schema
- No absolute filesystem paths sent to iframe (vault-relative only)
- See [docs/SECURITY.md](docs/SECURITY.md) for threat model

## Troubleshooting

### Blank iframe
- Ensure `assets/openwork/index.html` exists (run `bun run build:all`)
- Check browser console for CORS errors

### Server won't start
- Verify `opencode` is in PATH: `which opencode`
- Check Settings for correct executable path
- Review console for error messages

### Bridge messages ignored
- Verify channelId matches (check console logs)
- Ensure origin is in allowlist

## License

MIT

---

_This plugin is not affiliated with OpenCode or Obsidian. Third-party software._
